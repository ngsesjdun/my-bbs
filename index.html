<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>なんI</title>
<style>
  body{
    font-family: メイリオ, Meiryo, "ＭＳ ゴシック", "Hiragino Kaku Gothic ProN","ヒラギノ角ゴ ProN W3", sans-serif;
    background:#1c1c1c; color:#ddd; margin:0;
  }
  a{ color:#08f; text-decoration:none; }
  #header{ background:#333; color:#fff; padding:8px 10px; text-align:center; font-weight:bold; }
  #wrap{ max-width:640px; margin:0 auto; padding:10px; }

  /* スレ作成 */
  #new-thread{ margin:10px 0; display:flex; gap:6px; }
  #new-thread input{ flex:1; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }
  button{ padding:8px 10px; background:#444; color:#eee; border:1px solid #666; border-radius:6px; }
  button:active{ transform:translateY(1px); }

  /* スレ一覧 */
  #thread-box{ background:#2b2b2b; border-radius:6px; overflow:hidden; }
  .thread-row{ padding:8px 10px; border-bottom:1px solid #555; }
  .thread-row:last-child{ border-bottom:none; }
  .thread-link{ display:inline-block; }
  .thread-meta{ color:#999; font-size:.85em; margin-left:6px; }

  /* スレ表示 */
  #thread-view{ margin-top:12px; background:#2b2b2b; border-radius:6px; }
  #thread-title{ padding:8px 10px; border-bottom:1px solid #555; font-weight:bold; }
  #posts{ max-height:60vh; overflow-y:auto; padding:6px 8px; }
  .post{ padding:6px 4px; border-bottom:1px solid #555; white-space:pre-wrap; word-break:break-word; }
  .post:last-child{ border-bottom:none; }
  .no{ color:red; font-weight:bold; margin-right:6px; }
  .time{ color:#999; font-size:.85em; }

  /* 投稿フォーム（contentのみ） */
  #post-form-wrap{ padding:8px 10px; border-top:1px solid #555; }
  #post-form{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  #post-message{ flex:1; min-width:200px; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }

  .aa-measure{ position:absolute; visibility:hidden; display:none; width:0; height:0; padding:0; border:none; }
</style>
</head>
<body>
<h1>なんでも実況ジュピター</hq>

<div id="threadList">
  <h2>スレ一覧</h2>
  <form id="newThreadForm">
    <input id="newTitle" placeholder="スレタイ" required maxlength="50">
    <br>
    <textarea id="newContent" placeholder="本文 (>>1)" required maxlength="200"></textarea>
    <br>
    <button type="submit">新規スレ作成</button>
  </form>
  <div id="threads"></div>
</div>

<div id="postView" style="display:none;">
  <button id="btnBack">← スレ一覧へ</button>
  <h2 id="threadTitle"></h2>
  <div id="posts"></div>
  <form id="postForm">
    <input id="postContent" placeholder="書き込み" required maxlength="200">
    <button type="submit">投稿</button>
  </form>
  <button id="btnScroll">↓ 最新へ</button>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
const db = supabase.createClient("https://owopzgeliyhgxpnywscy.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8");

const threadList = document.getElementById("threadList");
const threadsEl = document.getElementById("threads");
const postView = document.getElementById("postView");
const postsEl = document.getElementById("posts");
const threadTitleEl = document.getElementById("threadTitle");
const formThread = document.getElementById("newThreadForm");
const formPost = document.getElementById("postForm");
const inputTitle = document.getElementById("newTitle");
const inputContent = document.getElementById("newContent");
const inputMsg = document.getElementById("postContent");
const btnBack = document.getElementById("btnBack");
const btnScroll = document.getElementById("btnScroll");

let currentThreadId=null;

function escapeHtml(str){
  const div=document.createElement("div");
  div.textContent=str;
  return div.innerHTML;
}
function formatTime(iso){
  const d=new Date(iso);
  return `${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}:${d.getSeconds().toString().padStart(2,"0")}`;
}
function generateDailyId(){
  const base="id"+Math.floor(Math.random()*1000);
  return base;
}

// スレ一覧を読み込み
async function loadThreads(){
  const {data,error}=await db.from("threads").select("id,title,created_at").order("updated_at",{ascending:false});
  if(error){ console.error(error); return; }
  threadsEl.innerHTML="";
  data.forEach(th=>{
    const div=document.createElement("div");
    div.className="thread";
    div.innerHTML=`${escapeHtml(th.title)} <span class="time">${formatTime(th.created_at)}</span>`;
    div.onclick=()=>openThread(th.id,th.title);
    threadsEl.appendChild(div);
  });
}

// スレを開く
async function openThread(id,title){
  currentThreadId=id;
  threadList.style.display="none";
  postView.style.display="block";
  threadTitleEl.textContent=title;
  await loadPosts();
}

// 投稿一覧
async function loadPosts(){
  const {data,error}=await db.from("posts").select("id,content,created_at").eq("thread_id",currentThreadId).order("id");
  if(error){ console.error(error); return; }
  postsEl.innerHTML="";
  data.forEach(p=>{
    const div=document.createElement("div");
    div.className="post";
    div.innerHTML=`${escapeHtml(p.content)} <span class="time">${formatTime(p.created_at)}</span>`;
    postsEl.appendChild(div);
  });
}

// スレ作成
formThread.addEventListener("submit",async e=>{
  e.preventDefault();
  const title=inputTitle.value.trim();
  const content=inputContent.value.trim();
  if(!title||!content) return;
  const {data:th,error:thErr}=await db.from("threads").insert([{title:title}]).select();
  if(thErr){ console.error(thErr); alert("スレ作成失敗"); return; }
  const threadId=th[0].id;
  const userId=generateDailyId();
  await db.from("posts").insert([{thread_id:threadId,content:`[${userId}] ${content}`}]);
  inputTitle.value=""; inputContent.value="";
  await loadThreads();
});

// レス投稿
formPost.addEventListener("submit",async e=>{
  e.preventDefault();
  const content=inputMsg.value.trim();
  if(!content) return;
  const userId=generateDailyId();
  const {error}=await db.from("posts").insert([{thread_id:currentThreadId,content:`[${userId}] ${content}`}]);
  if(error){ console.error(error); alert("投稿失敗"); return; }
  inputMsg.value="";
  await loadPosts();
  await loadThreads();
});

// 戻る
btnBack.addEventListener("click",()=>{
  currentThreadId=null;
  postView.style.display="none";
  threadList.style.display="block";
  window.scrollTo({top:0,behavior:"smooth"});
});

// 最新へジャンプ
btnScroll.addEventListener("click",()=>{
  if(postsEl.lastElementChild) postsEl.lastElementChild.scrollIntoView({behavior:"smooth",block:"end"});
});

// リアルタイム
db.channel("rt-posts")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},payload=>{
    if(payload?.new?.thread_id===currentThreadId) loadPosts();
    loadThreads();
  }).subscribe();

loadThreads();
</script>
</body>
</html>
