<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>なんI</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .hidden { display: none; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; }
    .thread-title { cursor: pointer; color: blue; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>なんでも実況ジュピター</h1>

  <!-- スレ一覧 -->
  <div id="threadListView">
    <h2>スレ一覧</h2>
    <ul id="threadList"></ul>
    <h3>新しいスレを立てる</h3>
    <form id="newThreadForm">
      <input type="text" id="newThreadTitle" placeholder="スレタイトル" required>
      <button type="submit">作成</button>
    </form>
  </div>

  <!-- スレ詳細 -->
  <div id="threadDetailView" class="hidden">
    <button id="backButton">← 戻る</button>
    <h2 id="threadTitle"></h2>
    <ul id="postList"></ul>

    <form id="postForm">
      <input type="text" id="postContent" placeholder="書き込み" required>
      <button type="submit">投稿</button>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabaseUrl = "https://owopzgeliyhgxpnywscy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
    const supabase = createClient(supabaseUrl, supabaseKey);


async function fetchThreads() {
  const { data, error } = await supabase
    .from("threads_with_activity")
    .select("*")
    .order("last_activity_at", { ascending: false }); // ←最新レスで上がる

  if (error) {
    console.error(error);
    return;
  }

  const threadList = document.getElementById("threadList");
  threadList.innerHTML = "";

  data.forEach((thread) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${thread.title}</strong> 
      （レス数: ${thread.post_count}）
      <br>
      最終更新: ${new Date(thread.last_activity_at).toLocaleString()}
    `;
    li.onclick = () => loadThread(thread.id, thread.title);
    threadList.appendChild(li);
  });
}

async function loadThread(threadId, title) {
  document.getElementById("threadTitle").innerText = title;

  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .eq("thread_id", threadId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  const postList = document.getElementById("postList");
  postList.innerHTML = "";
  data.forEach((post) => {
    const li = document.createElement("li");
    li.textContent = `${new Date(post.created_at).toLocaleTimeString()} ID:${post.user_hash} - ${post.content}`;
    postList.appendChild(li);
  });

  document.getElementById("postForm").onsubmit = async (e) => {
    e.preventDefault();
    const content = document.getElementById("postContent").value;

    const { error } = await supabase.from("posts").insert({
      thread_id: threadId,
      content: content,
      user_hash: genUserHash()
    });

    if (error) {
      console.error(error);
    } else {
      document.getElementById("postContent").value = "";
      loadThread(threadId, title);
      fetchThreads(); // ←書き込み後にスレ一覧も更新（上がる用）
    }
  };
}

// 簡易ID生成（0時で更新）
function genUserHash() {
  const today = new Date().toISOString().slice(0,10);
  return btoa(today + Math.random()).substring(0,4);
}

fetchThreads();
</script>
</body>
</html>
