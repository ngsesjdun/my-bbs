<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>匿名掲示板</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .hidden { display: none; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; }
    .thread-title { cursor: pointer; color: blue; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>メンテナンス</h1></h1>

  <!-- スレ一覧 -->
  <div id="threadListView">
    <h2>スレ一覧</h2>
    <ul id="threadList"></ul>
    <h3>新しいスレを立てる</h3>
    <form id="newThreadForm">
      <input type="text" id="newThreadTitle" placeholder="スレタイトル" required>
      <button type="submit">作成</button>
    </form>
  </div>

  <!-- スレ詳細 -->
  <div id="threadDetailView" class="hidden">
    <button id="backButton">← 戻る</button>
    <h2 id="threadTitle"></h2>
    <ul id="postList"></ul>

    <form id="postForm">
      <input type="text" id="postContent" placeholder="書き込み" required>
      <button type="submit">投稿</button>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabaseUrl = "https://owopzgeliyhgxpnywscy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const threadListView = document.getElementById("threadListView");
    const threadDetailView = document.getElementById("threadDetailView");
    const threadList = document.getElementById("threadList");
    const postList = document.getElementById("postList");
    const threadTitleEl = document.getElementById("threadTitle");
    let currentThreadId = null;

    // --- ユーザID（日付ごと固定） ---
    function genUserHash() {
      const today = new Date().toISOString().slice(0,10);
      return btoa(today + "fixed").substring(0,4);
    }

    // --- XSS対策 ---
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m]));
    }

    // --- NGワードチェック ---
    const NG_WORDS = ["spam","bot","悪意","<script>"];
    function containsNGWord(str) {
      const s = str.toLowerCase();
      return NG_WORDS.some(word => s.includes(word.toLowerCase()));
    }

    // --- レート制限 ---
    const lastPostTime = {};
    function canPost(userHash) {
      const now = Date.now();
      if (lastPostTime[userHash] && now - lastPostTime[userHash] < 60000) return false;
      lastPostTime[userHash] = now;
      return true;
    }

    // --- スレ一覧取得 ---
    async function fetchThreads() {
      const { data, error } = await supabase
        .from("threads_with_activity")
        .select("*")
        .order("last_activity_at", { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      threadList.innerHTML = "";
      data.forEach(thread => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="thread-title" data-id="${thread.id}">
            ${escapeHTML(thread.title)}
          </span>
          （レス数: ${thread.post_count}）
        `;
        threadList.appendChild(li);
      });

      document.querySelectorAll(".thread-title").forEach(el => {
        el.onclick = () => openThread(el.dataset.id, el.textContent);
      });
    }

    // --- スレ詳細表示 ---
    async function openThread(threadId, title) {
      currentThreadId = threadId;
      threadTitleEl.textContent = title;

      const { data: posts, error } = await supabase
        .from("posts")
        .select("*")
        .eq("thread_id", threadId)
        .order("created_at", { ascending: true });

      if (error) { console.error(error); return; }

      postList.innerHTML = "";
      posts.forEach(post => {
        const li = document.createElement("li");
        li.textContent = `${new Date(post.created_at).toLocaleTimeString()} ID:${post.user_hash} - ${escapeHTML(post.content)}`;
        postList.appendChild(li);
      });

      threadListView.classList.add("hidden");
      threadDetailView.classList.remove("hidden");
    }

    // --- 戻る ---
    document.getElementById("backButton").onclick = () => {
      threadDetailView.classList.add("hidden");
      threadListView.classList.remove("hidden");
      fetchThreads();
    };

    // --- スレ作成 ---
    document.getElementById("newThreadForm").onsubmit = async (e) => {
      e.preventDefault();
      const title = document.getElementById("newThreadTitle").value.trim();
      if (!title) return alert("タイトルを入力してください");
      if (containsNGWord(title)) return alert("NGワードが含まれています");

      const { data, error } = await supabase
        .from("threads")
        .insert({ title })
        .select()
        .single();

      if (error) { console.error(error); return; }

      document.getElementById("newThreadTitle").value = "";
      fetchThreads();
    };

    // --- 投稿 ---
    document.getElementById("postForm").onsubmit = async (e) => {
      e.preventDefault();
      const content = document.getElementById("postContent").value.trim();
      const userHash = genUserHash();

      if (!content) return alert("書き込みを入力してください");
      if (containsNGWord(content)) return alert("NGワードが含まれています");
      if (!canPost(userHash)) return alert("1分以内に連続投稿できません");

      const { error } = await supabase.from("posts").insert({
        thread_id: currentThreadId,
        content,
        user_hash: userHash
      });

      if (error) { console.error(error); return; }

      document.getElementById("postContent").value = "";
      openThread(currentThreadId, threadTitleEl.textContent);
    };

    // --- リアルタイム自動更新 ---
    supabase
      .channel('realtime-posts')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, payload => {
        fetchThreads();
        if (currentThreadId && payload.new.thread_id == currentThreadId) {
          openThread(currentThreadId, threadTitleEl.textContent);
        }
      })
      .subscribe();

    fetchThreads();

  </script>

  <!-- --- 何で見てんの？
  -->
</body>
</html>
