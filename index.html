<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>なんでも実況ジュピター</title>
<style>
  body{
    font-family: メイリオ, Meiryo, "ＭＳ ゴシック", "Hiragino Kaku Gothic ProN","ヒラギノ角ゴ ProN W3", sans-serif;
    background:#1c1c1c; color:#ddd; margin:0;
  }
  a{ color:#08f; text-decoration:none; }
  #header{ background:#333; color:#fff; padding:8px 10px; text-align:center; font-weight:bold; }
  #wrap{ max-width:640px; margin:0 auto; padding:10px; }

  /* スレ作成 */
  #new-thread{ margin:10px 0; display:flex; gap:6px; }
  #new-thread input{ flex:1; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }
  button{ padding:8px 10px; background:#444; color:#eee; border:1px solid #666; border-radius:6px; }
  button:active{ transform:translateY(1px); }

  /* スレ一覧 */
  #thread-box{ background:#2b2b2b; border-radius:6px; overflow:hidden; }
  .thread-row{ padding:8px 10px; border-bottom:1px solid #555; }
  .thread-row:last-child{ border-bottom:none; }
  .thread-link{ display:inline-block; }
  .thread-meta{ color:#999; font-size:.85em; margin-left:6px; }

  /* スレ表示 */
  #thread-view{ margin-top:12px; background:#2b2b2b; border-radius:6px; }
  #thread-title{ padding:8px 10px; border-bottom:1px solid #555; font-weight:bold; }
  #posts{ max-height:60vh; overflow-y:auto; padding:6px 8px; }
  .post{ padding:6px 4px; border-bottom:1px solid #555; white-space:pre-wrap; word-break:break-word; }
  .post:last-child{ border-bottom:none; }
  .no{ color:red; font-weight:bold; margin-right:6px; }
  .time{ color:#999; font-size:.85em; }

  /* 投稿フォーム（contentのみ） */
  #post-form-wrap{ padding:8px 10px; border-top:1px solid #555; }
  #post-form{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  #post-message{ flex:1; min-width:200px; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }

  .aa-measure{ position:absolute; visibility:hidden; display:none; width:0; height:0; padding:0; border:none; }
</style>
</head>
<body>
  <div id="header">なんでも実況ジュピター</div>
  <div id="wrap">
    <div id="new-thread">
      <input id="thread-title-input" type="text" placeholder="スレッドタイトル" />
      <button id="create-thread" type="button">スレ作成</button>
    </div>
    <div id="thread-box"></div>
    <div id="thread-view" style="display:none;">
      <div id="thread-title"></div>
      <div id="posts"></div>
      <div id="post-form-wrap">
        <form id="post-form" onsubmit="return false;">
          <input id="post-message" type="text" placeholder="本文（posts.content に保存）" />
          <button id="send" type="button">書き込む</button>
        </form>
        <button id="back" type="button">← スレ一覧へ</button>
      </div>
    </div>
    <span class="aa-measure">AA</span>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabaseUrl = "https://owopzgeliyhgxpnywscy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
const supabase = createClient(supabaseUrl, supabaseKey);

const threadListView = document.getElementById("threadListView");
const threadDetailView = document.getElementById("threadDetailView");
const threadList = document.getElementById("threadList");
const postList = document.getElementById("postList");
const threadTitleEl = document.getElementById("threadTitle");
let currentThreadId = null;

// ユーザID（日付ごと固定）
function genUserHash() {
  const today = new Date().toISOString().slice(0,10);
  return btoa(today + "fixed").substring(0,4);
}

// XSS対策
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m]));
}

// 簡易NGワード
const NG_WORDS = ["<script>",  "大麻"];
function containsNGWord(str) {
  return NG_WORDS.some(word => str.includes(word));
}

// 簡易レート制限
const lastPostTime = {};
function canPost(userHash) {
  const now = Date.now();
  if (lastPostTime[userHash] && now - lastPostTime[userHash] < 60000) return false;
  lastPostTime[userHash] = now;
  return true;
}

// スレ一覧を取得
async function fetchThreads() {
  const { data, error } = await supabase
    .from("threads_with_activity")
    .select("*")
    .order("last_activity_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  threadList.innerHTML = "";
  data.forEach((thread) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <span class="thread-title" data-id="${thread.id}">
        ${escapeHTML(thread.title)}
      </span>
      （レス数: ${thread.post_count}）
    `;
    threadList.appendChild(li);
  });

  document.querySelectorAll(".thread-title").forEach(el => {
    el.onclick = () => openThread(el.dataset.id, el.textContent);
  });
}

// スレ詳細を表示
async function openThread(threadId, title) {
  currentThreadId = threadId;
  threadTitleEl.textContent = title;

  const { data: posts, error } = await supabase
    .from("posts")
    .select("*")
    .eq("thread_id", threadId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  postList.innerHTML = "";
  posts.forEach(post => {
    const li = document.createElement("li");
    li.textContent = `${new Date(post.created_at).toLocaleTimeString()} ID:${post.user_hash} - ${escapeHTML(post.content)}`;
    postList.appendChild(li);
  });

  threadListView.classList.add("hidden");
  threadDetailView.classList.remove("hidden");
}

// 戻る
document.getElementById("backButton").onclick = () => {
  threadDetailView.classList.add("hidden");
  threadListView.classList.remove("hidden");
  fetchThreads();
};

// スレ作成
document.getElementById("newThreadForm").onsubmit = async (e) => {
  e.preventDefault();
  const title = document.getElementById("newThreadTitle").value.trim();
  if (!title) return alert("タイトルを入力してください");
  if (containsNGWord(title)) return alert("NGワードが含まれています");

  const { data, error } = await supabase
    .from("threads")
    .insert({ title })
    .select()
    .single();

  if (error) {
    console.error(error);
    return;
  }

  document.getElementById("newThreadTitle").value = "";
  fetchThreads();
};

// 投稿
document.getElementById("postForm").onsubmit = async (e) => {
  e.preventDefault();
  const content = document.getElementById("postContent").value.trim();
  const userHash = genUserHash();

  if (!content) return alert("書き込みを入力してください");
  if (containsNGWord(content)) return alert("NGワードが含まれています");
  if (!canPost(userHash)) return alert("1分以内に連続投稿できません");

  const { error } = await supabase.from("posts").insert({
    thread_id: currentThreadId,
    content: content,
    user_hash: userHash
  });

  if (error) {
    console.error(error);
  } else {
    document.getElementById("postContent").value = "";
    openThread(currentThreadId, threadTitleEl.textContent);
  }
};

// --- リアルタイム自動更新 ---
supabase
  .channel('realtime-posts')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, payload => {
    // 新しいレスが来たら一覧を最新順で更新
    fetchThreads();
    if (currentThreadId && payload.new.thread_id == currentThreadId) {
      openThread(currentThreadId, threadTitleEl.textContent);
    }
  })
  .subscribe();

fetchThreads();
</script>
</body>
</html>
