<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おんJ風掲示板</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; }
    #threadList, #threadView { padding: 1em; }
    .thread { background: #fff; margin: 0.5em 0; padding: 0.5em; border-radius: 8px; cursor: pointer; }
    .post { background: #fff; margin: 0.5em 0; padding: 0.5em; border-radius: 8px; }
    #scrollBtn { 
      position: fixed; bottom: 20px; right: 20px; 
      padding: 10px 16px; border-radius: 50%; 
      border: none; background: #007bff; color: #fff; 
      cursor: pointer; font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="threadList"></div>
  <div id="threadView" style="display:none;">
    <button id="btnBack">← 戻る</button>
    <div id="posts"></div>
    <form id="formPost">
      <input id="inputMsg" type="text" placeholder="レスを書く…" maxlength="200">
      <button type="submit">投稿</button>
    </form>
  </div>
  <button id="scrollBtn" title="最新レスへ">↓</button>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";
    const db = createClient("https://owopzgeliyhgxpnywscy.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8");

    const threadListEl = document.getElementById("threadList");
    const threadViewEl = document.getElementById("threadView");
    const postsEl = document.getElementById("posts");
    const inputMsg = document.getElementById("inputMsg");
    const formPost = document.getElementById("formPost");
    const btnBack = document.getElementById("btnBack");
    const btnScroll = document.getElementById("scrollBtn");

    let currentThreadId = null;

    // thread一覧を読み込み
    async function loadThreads() {
      const { data, error } = await db.from("threads")
        .select("id,title,created_at,posts(created_at)")
        .order("created_at", { ascending: false });
      if(error) return console.error(error);

      threadListEl.innerHTML = "";
      data.forEach(t => {
        const div = document.createElement("div");
        div.className = "thread";
        const latest = t.posts.length ? new Date(t.posts.at(-1).created_at) : new Date(t.created_at);
        div.textContent = `${t.title}  (+${t.posts.length})  [${latest.toLocaleString()}]`;
        div.onclick = () => openThread(t.id);
        threadListEl.appendChild(div);
      });
    }

    // threadを開く
    async function openThread(id) {
      currentThreadId = id;
      threadListEl.style.display = "none";
      threadViewEl.style.display = "block";
      await loadPosts();
    }

    // 投稿一覧
    async function loadPosts() {
      const { data, error } = await db.from("posts")
        .select("*")
        .eq("thread_id", currentThreadId)
        .order("created_at");
      if(error) return console.error(error);

      postsEl.innerHTML = "";
      data.forEach(p => {
        const div = document.createElement("div");
        div.className = "post";
        div.textContent = `[${new Date(p.created_at).toLocaleTimeString()}] ${p.content}`;
        postsEl.appendChild(div);
      });
    }

    // 投稿処理
    formPost.addEventListener("submit", async (e) => {
      e.preventDefault();
      const content = inputMsg.value.trim();
      if(!content) return;
      if(content.length>200){ alert("200文字まで"); return; }

      const { error } = await db.from("posts").insert([{ thread_id: currentThreadId, content }]);
      if(error){ console.error(error); alert("投稿失敗"); return; }
      inputMsg.value = "";
      await loadPosts();
      await loadThreads(); // スレ一覧更新
    });

    // スレ一覧へ戻る
    btnBack.addEventListener("click", ()=>{
      currentThreadId = null;
      threadViewEl.style.display = "none";
      threadListEl.style.display = "block";
    });

    // 最新レスへジャンプ（手動のみ）
    btnScroll.addEventListener("click", ()=>{
      if(postsEl.lastElementChild){
        postsEl.lastElementChild.scrollIntoView({ behavior:"instant", block:"end" });
      }
    });

    // リアルタイム購読
    db.channel("rt-posts")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},payload=>{
        if(payload?.new?.thread_id===currentThreadId) loadPosts();
        loadThreads();
      }).subscribe();

    loadThreads();
  </script>
</body>
</html>
