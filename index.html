<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おんJ風掲示板</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 20px; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    .thread, .post { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .meta { color: gray; font-size: 0.9em; }
    button { margin-top: 10px; padding: 5px 10px; }
    textarea, input { width: 100%; padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>おんJ風掲示板</h1>
    <div id="view"></div>
  </div>

  <script type="module">
    // shine
    const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
    const TEST = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, TEST);

    // aho
    const ngWords = ["爆破", "大麻", "殺す"];

    
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m]));
    }

  
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    
    function checkNG(text) {
      return ngWords.some(word => text.includes(word));
    }
    
    
    async function showThreads() {
      const { data } = await supabase.from("threads").select("*").order("created_at", { ascending: false });
      const el = document.getElementById("view");
      el.innerHTML = `
        <button onclick="showNewThreadForm()">新規スレ作成</button>
        <h2>スレ一覧</h2>
        ${data.map(t => `
          <div class="thread">
            <a href="#" onclick="showThread(${t.id})">${escapeHTML(t.title)}</a>
            <div class="meta">${formatDate(t.created_at)}</div>
          </div>
        `).join("")}
      `;
    }
    
    window.showNewThreadForm = function() {
      document.getElementById("view").innerHTML = `
        <h2>新規スレ作成</h2>
        <input id="title" placeholder="スレタイトル">
        <textarea id="content" placeholder="本文"></textarea>
        <button onclick="createThread()">作成</button>
        <button onclick="showThreads()">戻る</button>
      `;
    };

  
    window.createThread = async function() {
      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      if (!title || !content) return alert("空投稿は禁止や！");
      if (checkNG(title) || checkNG(content)) return alert("NGワードが含まれています");

      const { data, error } = await supabase.from("threads").insert([{ title }]).select().single();
      if (error) return alert("投稿失敗: " + error.message);

      await supabase.from("posts").insert([{ thread_id: data.id, content }]);
      showThreads();
    };

    
    window.showThread = async function(id) {
      const { data: thread } = await supabase.from("threads").select("*").eq("id", id).single();
      const { data: posts } = await supabase.from("posts").select("*").eq("thread_id", id).order("created_at");
      document.getElementById("view").innerHTML = `
        <h2>${escapeHTML(thread.title)}</h2>
        ${posts.map(p => `
          <div class="post">
            ${escapeHTML(p.content)}
            <div class="meta">${formatDate(p.created_at)}</div>
          </div>
        `).join("")}
        <textarea id="reply" placeholder="レスを書く"></textarea>
        <button onclick="createPost(${id})">投稿</button>
        <button onclick="showThreads()">戻る</button>
      `;
    };

    // レス投稿
    window.createPost = async function(threadId) {
      const content = document.getElementById("reply").value.trim();
      if (!content) return alert("空投稿は禁止や！");
      if (checkNG(content)) return alert("NGワードが含まれています");

      const { error } = await supabase.from("posts").insert([{ thread_id: threadId, content }]);
      if (error) return alert("投稿失敗: " + error.message);
      showThread(threadId);
    };

    // 初期表示
    showThreads();
  </script>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</body>
</html>
