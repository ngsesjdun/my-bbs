<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>なんI 安全版</title>
<style>
body{ font-family: メイリオ,Meiryo,"ＭＳ ゴシック",sans-serif; background:#1c1c1c; color:#ddd; margin:0; }
a{ color:#08f; text-decoration:none; }
#header{ background:#333; color:#fff; padding:8px 10px; text-align:center; font-weight:bold; }
#wrap{ max-width:640px; margin:0 auto; padding:10px; }

#new-thread{ margin:10px 0; display:flex; flex-direction:column; gap:6px; }
#new-thread input, #new-thread textarea{ padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }
button{ padding:8px 10px; background:#444; color:#eee; border:1px solid #666; border-radius:6px; cursor:pointer; }
button:active{ transform:translateY(1px); }

#thread-box{ background:#2b2b2b; border-radius:6px; overflow:hidden; }
.thread-row{ padding:8px 10px; border-bottom:1px solid #555; cursor:pointer; }
.thread-row:last-child{ border-bottom:none; }
.thread-link{ display:inline-block; }
.thread-meta{ color:#999; font-size:.85em; margin-left:6px; }

#thread-view{ margin-top:12px; background:#2b2b2b; border-radius:6px; }
#thread-title{ padding:8px 10px; border-bottom:1px solid #555; font-weight:bold; }
#posts{ max-height:60vh; overflow-y:auto; padding:6px 8px; }
.post{ padding:6px 4px; border-bottom:1px solid #555; white-space:pre-wrap; word-break:break-word; }
.post:last-child{ border-bottom:none; }
.no{ color:red; font-weight:bold; margin-right:6px; }
.time{ color:#999; font-size:.85em; }

#post-form-wrap{ padding:8px 10px; border-top:1px solid #555; }
#post-form{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
#post-message{ flex:1; min-width:200px; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }
</style>
</head>
<body>
<div id="header">なんでも実況ジュピター</div>
<div id="wrap">
  <div id="new-thread">
    <input id="thread-title-input" type="text" placeholder="スレッドタイトル" />
    <textarea id="thread-body-input" rows="3" placeholder="本文（>>1）"></textarea>
    <button id="create-thread" type="button">スレ作成</button>
  </div>
  <div id="thread-box"></div>
  <div id="thread-view" style="display:none;">
    <div id="thread-title"></div>
    <div id="posts"></div>
    <div id="post-form-wrap">
      <form id="post-form" onsubmit="return false;">
        <input id="post-message" type="text" placeholder="本文（posts.content に保存）" />
        <button id="send" type="button">書き込む</button>
      </form>
      <button id="back" type="button">← スレ一覧へ</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
const SUPABASETAISAKU = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8"; // 文字化けしないように
const db = createClient(SUPABASE_URL, SUPABASETAISAKU);

const threadBox = document.getElementById("thread-box");
const postsEl   = document.getElementById("posts");
const viewWrap  = document.getElementById("thread-view");
const viewTitle = document.getElementById("thread-title");
const newTitle  = document.getElementById("thread-title-input");
const newBody   = document.getElementById("thread-body-input");
const btnCreate = document.getElementById("create-thread");
const inputMsg  = document.getElementById("post-message");
const btnSend   = document.getElementById("send");
const btnBack   = document.getElementById("back");

let currentThreadId = null;
let lastPostTime = 0;

// 4文字 ID
let currentId = null;
let lastIdDate = null;
function generateDailyId(){
  const today = new Date().toISOString().slice(0,10);
  if(currentId && lastIdDate === today) return currentId;
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let id='';
  for(let i=0;i<4;i++) id+=chars.charAt(Math.floor(Math.random()*chars.length));
  currentId=id; lastIdDate=today;
  return id;
}
generateDailyId();

const fmt = ts=>{
  if(!ts) return "";
  const d = new Date(ts);
  if(isNaN(d)) return "";
  const pad=(n,l=2)=>String(n).padStart(l,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

async function loadThreads(){
  const { data,error } = await db.from("threads").select("*").order("created_at",{ascending:false});
  if(error){ console.error(error); return; }
  threadBox.innerHTML="";
  (data||[]).forEach(th=>{
    const row = document.createElement("div");
    row.className="thread-row";
    row.dataset.threadId=th.id;
    const a = document.createElement("a");
    a.className="thread-link";
    a.href="#thread-view";
    a.textContent=th.title;
    a.onclick = e=>{ e.preventDefault(); openThread(th.id,th.title); };
    const meta = document.createElement("span");
    meta.className="thread-meta";
    meta.textContent=fmt(th.created_at);
    row.appendChild(a); row.appendChild(meta);
    threadBox.appendChild(row);
  });
}

btnCreate.addEventListener("click",async()=>{
  const title = newTitle.value.trim();
  const body  = newBody.value.trim();
  if(!title){ alert("タイトルを入れて"); return; }
  if(!body){ alert("本文を入れて"); return; }

  const { data,error } = await db.from("threads").insert([{title}]).select().limit(1).maybeSingle();
  if(error){ console.error(error); alert("スレ作成失敗"); return; }

  const userId = generateDailyId();
  await db.from("posts").insert([{thread_id:data.id,content:`[${userId}] ${body}`}]);

  newTitle.value=""; newBody.value="";
  await loadThreads();
  if(data?.id) openThread(data.id,data.title);
});

async function openThread(id,title){
  currentThreadId=id;
  viewTitle.textContent=title;
  viewWrap.style.display="block";
  document.getElementById("thread-view").scrollIntoView({behavior:"smooth",block:"start"});
  await loadPosts();
}

async function loadPosts(){
  if(!currentThreadId) return;
  const { data,error } = await db.from("posts")
    .select("id,content,created_at,thread_id")
    .eq("thread_id",currentThreadId)
    .order("created_at",{ascending:true});
  if(error){ console.error(error); return; }
  postsEl.innerHTML="";
  (data||[]).forEach((p,i)=>{
    const div = document.createElement("div");
    div.className="post";
    const no = document.createElement("span"); no.className="no"; no.textContent=i+1;
    const content = document.createElement("span"); content.textContent=p.content||"";
    const time = document.createElement("span"); time.className="time"; time.textContent=fmt(p.created_at);
    div.appendChild(no); div.appendChild(document.createTextNode(" ")); div.appendChild(content);
    div.appendChild(document.createElement("br")); div.appendChild(time);
    postsEl.appendChild(div);
  });
  postsEl.scrollTo({top: postsEl.scrollHeight});
}

btnSend.addEventListener("click",async()=>{
  const now=Date.now();
  if(now-lastPostTime<2000){ alert("連投は2秒空けてください"); return; }
  if(!currentThreadId) return;
  let content=inputMsg.value.trim();
  if(!content) return;
  if(content.length>200){ alert("本文は200文字までです"); return; }

  const userId=generateDailyId();
  const { error } = await db.from("posts").insert([{thread_id:currentThreadId,content:`[${userId}] ${content}`}]);
  if(error){ console.error(error); alert("投稿失敗"); return; }
  inputMsg.value=""; lastPostTime=now; await loadPosts();
  bumpThread(currentThreadId);
});

btnBack.addEventListener("click",()=>{
  currentThreadId=null; viewWrap.style.display="none"; window.scrollTo({top:0,behavior:"smooth"});
});

function bumpThread(threadId){
  const target = threadBox.querySelector(`.thread-row[data-thread-id='${threadId}']`);
  if(target) threadBox.prepend(target);
}

db.channel("rt-posts")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"}, payload=>{
    if(payload?.new?.thread_id===currentThreadId) loadPosts();
    bumpThread(payload?.new?.thread_id);
  }).subscribe();

loadThreads();
</script>
</body>
</html>
