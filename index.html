<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>おんJ風掲示板</title>
<style>
  body{
    font-family: メイリオ, Meiryo, "ＭＳ ゴシック", "Hiragino Kaku Gothic ProN","ヒラギノ角ゴ ProN W3", sans-serif;
    background:#1c1c1c; color:#ddd; margin:0;
  }
  a{ color:#08f; text-decoration:none; }
  #header{ background:#333; color:#fff; padding:8px 10px; text-align:center; font-weight:bold; }
  #wrap{ max-width:640px; margin:0 auto; padding:10px; }

  /* スレ作成 */
  #new-thread{ margin:10px 0; display:flex; gap:6px; }
  #new-thread input{ flex:1; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }
  button{ padding:8px 10px; background:#444; color:#eee; border:1px solid #666; border-radius:6px; }
  button:active{ transform:translateY(1px); }

  /* スレ一覧 */
  #thread-box{ background:#2b2b2b; border-radius:6px; overflow:hidden; }
  .thread-row{ padding:8px 10px; border-bottom:1px solid #555; }
  .thread-row:last-child{ border-bottom:none; }
  .thread-link{ display:inline-block; }
  .thread-meta{ color:#999; font-size:.85em; margin-left:6px; }

  /* スレ表示 */
  #thread-view{ margin-top:12px; background:#2b2b2b; border-radius:6px; }
  #thread-title{ padding:8px 10px; border-bottom:1px solid #555; font-weight:bold; }
  #posts{ max-height:60vh; overflow-y:auto; padding:6px 8px; }
  .post{ padding:6px 4px; border-bottom:1px solid #555; white-space:pre-wrap; word-break:break-word; }
  .post:last-child{ border-bottom:none; }
  .no{ color:red; font-weight:bold; margin-right:6px; }
  .time{ color:#999; font-size:.85em; }

  /* 投稿フォーム（contentのみ） */
  #post-form-wrap{ padding:8px 10px; border-top:1px solid #555; }
  #post-form{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  #post-message{ flex:1; min-width:200px; padding:8px; background:#222; border:1px solid #444; color:#ddd; border-radius:4px; }

  .aa-measure{ position:absolute; visibility:hidden; display:none; width:0; height:0; padding:0; border:none; }
</style>
</head>
<body>
  <div id="header">おんJ風掲示板</div>
  <div id="wrap">
    <!-- スレ作成 -->
    <div id="new-thread">
      <input id="thread-title-input" type="text" placeholder="スレッドタイトル" />
      <button id="create-thread" type="button">スレ作成</button>
    </div>

    <!-- スレ一覧 -->
    <div id="thread-box"></div>

    <!-- スレ表示（下に出す） -->
    <div id="thread-view" style="display:none;">
      <div id="thread-title"></div>
      <div id="posts"></div>
      <div id="post-form-wrap">
        <form id="post-form" onsubmit="return false;">
          <input id="post-message" type="text" placeholder="本文（posts.content に保存）" />
          <button id="send" type="button">書き込む</button>
        </form>
        <button id="back" type="button">← スレ一覧へ</button>
      </div>
    </div>

    <span class="aa-measure">AA</span>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // あなたの接続情報（提供済み）
  const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  // DOM
  const threadBox = document.getElementById("thread-box");
  const postsEl   = document.getElementById("posts");
  const viewWrap  = document.getElementById("thread-view");
  const viewTitle = document.getElementById("thread-title");
  const newTitle  = document.getElementById("thread-title-input");
  const btnCreate = document.getElementById("create-thread");
  const inputMsg  = document.getElementById("post-message");
  const btnSend   = document.getElementById("send");
  const btnBack   = document.getElementById("back");

  let currentThreadId = null;

  // ===== 共通ユーティリティ =====
  const JST_OFFSET_MS = 9 * 60 * 60 * 1000; // UTC→JST
  const fmt = (ts) => ts ? new Date(ts + "Z").toLocaleString("ja-JP",{hour12:false}) : "";

  // 当日キー（JSTで日替わり）
  const jstDateKey = (dateLike) => {
    const t = (dateLike instanceof Date) ? dateLike.getTime() : Date.parse(dateLike);
    const j = new Date(t + JST_OFFSET_MS);
    const y = j.getUTCFullYear();
    const m = String(j.getUTCMonth()+1).padStart(2,'0');
    const d = String(j.getUTCDate()).padStart(2,'0');
    return `${y}${m}${d}`; // YYYYMMDD
  };

  // 簡易ハッシュ（DJB2）
  const hashStr = (s) => {
    let h = 5381;
    for (let i=0;i<s.length;i++) h = ((h<<5)+h) + s.charCodeAt(i);
    return (h >>> 0); // uint32
  };

  // 4文字ID（当日・スレID・レスIDで決定論的）
  const postId4 = (thread_id, post_id, created_at) => {
    const day = jstDateKey(created_at ?? Date.now());
    const h = hashStr(`${thread_id}|${post_id}|${day}`);
    // base36→上位4文字（読みやすさ優先で先頭4）
    return h.toString(36).toUpperCase().padStart(4,'0').slice(0,4);
  };

  // ===== 連投制限（フロント側） =====
  const POST_LIMIT_MS = 2000;       // 2秒
  const BURST_LIMIT_N = 15;         // 15連投
  const BURST_WINDOW_MS = 60_000;   // 60秒
  const BURST_PENALTY_MS = 60_000;  // 1分ロック
  const LS_KEY = "onj_rate";

  const nowMs = () => Date.now();

  const loadRate = () => {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch { return {}; }
  };
  const saveRate = (obj) => localStorage.setItem(LS_KEY, JSON.stringify(obj));

  const canPost = () => {
    const st = loadRate();
    const n = nowMs();

    // 直近投稿時刻チェック
    if (st.lastPostAt && n - st.lastPostAt < POST_LIMIT_MS) {
      const wait = Math.ceil((POST_LIMIT_MS - (n - st.lastPostAt))/1000);
      return { ok:false, msg:`連投制限中です（${wait}秒）` };
    }

    // バーストロック
    if (st.lockUntil && n < st.lockUntil) {
      const wait = Math.ceil((st.lockUntil - n)/1000);
      return { ok:false, msg:`連投ロック中です（${wait}秒）` };
    }

    // 直近60秒の自己投稿件数
    const arr = (st.times || []).filter(t => n - t <= BURST_WINDOW_MS);
    if (arr.length >= BURST_LIMIT_N) {
      // ロック発動
      st.lockUntil = n + BURST_PENALTY_MS;
      st.times = arr;
      saveRate(st);
      return { ok:false, msg:"15連投に達しました。1分間書き込めません。" };
    }

    return { ok:true };
  };

  const markPosted = () => {
    const st = loadRate();
    const n = nowMs();
    const arr = (st.times || []).filter(t => n - t <= BURST_WINDOW_MS);
    arr.push(n);
    st.times = arr;
    st.lastPostAt = n;
    saveRate(st);
  };

  // ===== スレ一覧 =====
  async function loadThreads(){
    const { data, error } = await db.from("threads")
      .select("*")
      .order("created_at", { ascending:false });
    if(error){ console.error("スレ一覧エラー:", error); return; }
    threadBox.innerHTML = "";
    (data||[]).forEach(th=>{
      const row = document.createElement("div");
      row.className = "thread-row";
      const a = document.createElement("a");
      a.className = "thread-link";
      a.href = "#thread-view";
      a.textContent = th.title;
      a.onclick = (e)=>{ e.preventDefault(); openThread(th.id, th.title); };
      const meta = document.createElement("span");
      meta.className = "thread-meta";
      meta.textContent = fmt(th.created_at);
      row.appendChild(a);
      row.appendChild(meta);
      threadBox.appendChild(row);
    });
  }

  // スレ作成
  btnCreate.addEventListener("click", async ()=>{
    const title = newTitle.value.trim();
    if(!title){ alert("タイトルを入れて"); return; }
    if (title.length > 200) { alert("スレタイは200文字以内にしてください"); return; }

    const { data, error } = await db.from("threads").insert([{ title }]).select().limit(1).maybeSingle();
    if(error){ console.error("スレ作成失敗:", error); alert("スレ作成失敗"); return; }
    newTitle.value = "";
    await loadThreads();
    if(data?.id){ openThread(data.id, data.title); }
  });

  // スレを開く
  async function openThread(id, title){
    currentThreadId = id;
    viewTitle.textContent = title;
    viewWrap.style.display = "block";
    document.getElementById("thread-view").scrollIntoView({ behavior:"smooth", block:"start" });
    await loadPosts();
  }

  // レス一覧（ID/時間付き）
  async function loadPosts(){
    if(!currentThreadId) return;
    const { data, error } = await db.from("posts")
      .select("id,content,created_at,thread_id")
      .eq("thread_id", currentThreadId)
      .order("created_at", { ascending:true });
    if(error){ console.error("レス読み込み失敗:", error); return; }
    postsEl.innerHTML = "";
    (data||[]).forEach((p,i)=>{
      const id4 = postId4(p.thread_id, p.id, p.created_at);
      const d = p.created_at ? new Date(p.created_at + "Z") : null;
      const timeJ = d ? d.toLocaleTimeString("ja-JP",{hour12:false, hour:"2-digit", minute:"2-digit"}) : "";
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<span class="no">${i+1}</span> ${p.content || ""}<br><span class="time">${timeJ} ID:${id4}</span>`;
      postsEl.appendChild(div);
    });
    postsEl.scrollTop = postsEl.scrollHeight;
  }

  // レス投稿（200文字制限＋連投制限）
  btnSend.addEventListener("click", async ()=>{
    if(!currentThreadId) return;
    const content = inputMsg.value.trim();
    if(!content){ return; }
    if (content.length > 200) {
      alert("本文は200文字以内にしてください");
      return;
    }

    const { ok, msg } = canPost();
    if (!ok) { alert(msg); return; }

    const { error } = await db.from("posts").insert([{ thread_id: currentThreadId, content }]);
    if(error){ console.error("投稿失敗:", error); alert("投稿失敗"); return; }
    markPosted();
    inputMsg.value = "";
    await loadPosts();
  });

  // 戻る
  btnBack.addEventListener("click", ()=>{
    currentThreadId = null;
    viewWrap.style.display = "none";
    window.scrollTo({ top:0, behavior:"smooth" });
  });

  // リアルタイム（開いてるスレだけ反映）
  db.channel("rt-posts")
    .on("postgres_changes",{ event:"INSERT", schema:"public", table:"posts" }, payload=>{
      if(payload?.new?.thread_id === currentThreadId){ loadPosts(); }
    })
    .subscribe();

  // 初期ロード
  loadThreads();
</script>
</body>
</html>
