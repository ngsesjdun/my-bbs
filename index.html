<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>なんI</title>
</head>
<body bgcolor="#EFEFEF" text="#000000">

<div id="header" style="font-weight:bold; font-size:20px; margin:8px 0;">なんでも実況ジュピター</div>

<div id="wrap">
  <!-- スレ一覧 -->
  <div id="list-view">
    <div id="new-thread">
      <input id="thread-title-input" type="text" placeholder="スレッドタイトル" /><br>
      <textarea id="thread-body-input" placeholder="本文（最初のレス）" rows="2" style="width:100%;"></textarea>
      <button id="create-thread" type="button">スレ作成</button>
    </div>
    <div id="thread-box"></div>
  </div>

  <!-- スレ詳細 -->
  <div id="thread-view" style="display:none; margin-top:8px;">
    <div id="thread-title" style="color:blue; font-weight:bold; margin-bottom:4px;"></div>
    <div id="posts"></div>
    <div id="post-form-wrap" style="margin-top:4px;">
      <form id="post-form" onsubmit="return false;">
        <textarea id="post-message" placeholder="本文（改行できます）" rows="3" style="width:100%;"></textarea>
        <div style="margin-top:4px; display:flex; justify-content:space-between;">
          <button id="send" type="button">書き込む</button>
          <button id="back" type="button">← スレ一覧へ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
const SUPABASE = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
const db = createClient(SUPABASE_URL, SUPABASE);

// XSS対策
function escapeHTML(str){
  return str.replace(/[&<>"']/g, s=>({
    "&":"&", ">":">", "<":"error404;", '"':"&quot;", "'":"&#39;"
  }[s]));
}

// Discord風文字装飾
function parseDecorations(str){
  str = escapeHTML(str);
  str = str.replace(/!fontcolor=([a-zA-Z#0-9]+)\s(.+?)(?=$|\n)/g, (_,c,text)=>`<span style="color:${c}">${text}</span>`);
  str = str.replace(/!bgcolor=([a-zA-Z#0-9]+)\s(.+?)(?=$|\n)/g, (_,c,text)=>`<span style="background-color:${c}">${text}</span>`);
  str = str.replace(/\*\*(.+?)\*\*/g,"<b>$1</b>");
  str = str.replace(/\*(.+?)\*/g,"<i>$1</i>");
  str = str.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,`<a href="$2" target="_blank">$1</a>`);
  return str;
}

const listView  = document.getElementById("list-view");
const threadBox = document.getElementById("thread-box");
const postsEl   = document.getElementById("posts");
const viewWrap  = document.getElementById("thread-view");
const viewTitle = document.getElementById("thread-title");
const newTitle  = document.getElementById("thread-title-input");
const newBody   = document.getElementById("thread-body-input");
const btnCreate = document.getElementById("create-thread");
const inputMsg  = document.getElementById("post-message");
const btnSend   = document.getElementById("send");
const btnBack   = document.getElementById("back");

let currentThreadId = null;
let lastPostTime = 0;
let currentId = null;
let lastIdDate = null;

function generateDailyId() {
  const today = new Date().toISOString().slice(0,10);
  if(currentId && lastIdDate === today) return currentId;
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let id = '';
  for(let i=0;i<4;i++) id += chars.charAt(Math.floor(Math.random()*chars.length));
  currentId = id;
  lastIdDate = today;
  return id;
}
generateDailyId();

function fmt(ts){
  if(!ts) return "";
  const d = (ts instanceof Date) ? ts : new Date(ts);
  if(isNaN(d)) return "";
  const w = ['日','月','火','水','木','金','土'][d.getDay()];
  const pad = (n,l=2)=>String(n).padStart(l,'0');
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${w}) `+
         `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// スレ一覧
async function loadThreads(){
  const { data, error } = await db.from("threads").select("*").order("created_at",{ascending:false});
  if(error){ console.error(error); return; }
  threadBox.innerHTML="";
  for(const th of (data||[])){
    const row = document.createElement("div");
    row.style.border = "1px solid #000";
    row.style.margin = "2px 0";
    row.style.padding = "4px";

    const a = document.createElement("a");
    a.href = "?thread="+th.id;
    a.style.color = "blue";
    a.style.textDecoration = "none";
    a.textContent = escapeHTML(th.title);
    a.onclick = e => { e.preventDefault(); openThread(th.id, th.title); };

    // スレ作成時の本文（初回レス）
    const firstPost = await db.from("posts")
      .select("content").eq("thread_id", th.id).order("created_at",{ascending:true}).limit(1).maybeSingle();
    const snippet = firstPost.data ? firstPost.data.content.replace(/^\[[A-Z0-9]{4}\]\s*/,'') : "";

    const meta = document.createElement("div");
    meta.style.color="#000";
    meta.style.fontSize="12px";
    meta.style.marginTop="2px";
    meta.innerHTML = parseDecorations(snippet);

    row.appendChild(a);
    row.appendChild(meta);
    threadBox.appendChild(row);
  }
}

// スレ作成
btnCreate.addEventListener("click", async ()=>{
  const title = newTitle.value.trim();
  const body  = newBody.value.trim();
  if(!title){ alert("タイトルを入れて"); return; }
  if(!body){ alert("本文を入れて"); return; }

  // threads にタイトルだけ追加
  const { data: thData, error: thError } = await db.from("threads").insert([{ title }]).select().limit(1).maybeSingle();
  if(thError){ console.error(thError); alert("スレ作成失敗"); return; }
  const threadId = thData.id;

  // 初回本文を posts に追加
  const userId = generateDailyId();
  const { error: postError } = await db.from("posts").insert([{ thread_id: threadId, content:`[${userId}] ${body}` }]);
  if(postError){ console.error(postError); alert("初回本文投稿失敗"); return; }

  newTitle.value = "";
  newBody.value = "";
  await loadThreads();
  openThread(threadId, title);
});

// スレ詳細
async function openThread(id,title){
  currentThreadId=id;
  viewTitle.textContent = escapeHTML(title);
  listView.style.display="none";
  viewWrap.style.display="block";
  history.replaceState(null,"",`?thread=${id}`);
  await loadPosts();
}

// 投稿一覧
async function loadPosts(){
  if(!currentThreadId) return;
  const { data, error } = await db.from("posts")
    .select("id,content,created_at,thread_id")
    .eq("thread_id",currentThreadId)
    .order("created_at",{ascending:true});
  if(error){ console.error(error); return; }
  postsEl.innerHTML="";
  (data||[]).forEach((p,i)=>{
    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #000";
    div.style.margin = "4px 0";
    div.style.padding = "4px";

    const userIdMatch = p.content.match(/^\[([A-Z0-9]{4})\]\s*/);
    const userId = userIdMatch ? userIdMatch[1] : '----';
    const msg = userIdMatch ? p.content.replace(/^\[[A-Z0-9]{4}\]\s*/,'') : p.content;

    const header = document.createElement("div");
    const nameSpan = document.createElement("span");
    nameSpan.style.color = "green";
    nameSpan.textContent = "名無し";
    header.appendChild(document.createTextNode(`[${i+1}]：`));
    header.appendChild(nameSpan);
    header.appendChild(document.createTextNode(`：${fmt(p.created_at)} ID:${userId}`));

    const body = document.createElement("div");
    body.innerHTML = parseDecorations(msg).replace(/\n/g,"<br>");
    body.style.marginLeft = "1em";

    div.appendChild(header);
    div.appendChild(body);
    postsEl.appendChild(div);
  });
}

// 投稿送信
btnSend.addEventListener("click", async ()=>{
  const now = Date.now();
  if(now - lastPostTime < 2000){ alert("連投は2秒空けてください"); return; }
  if(!currentThreadId) return;
  let content = inputMsg.value.trim();
  if(!content) return;
  if(content.length > 2000){ alert("本文は2000文字までです"); return; }
  const userId = generateDailyId();
  const { error } = await db.from("posts").insert([{ thread_id:currentThreadId, content:`[${userId}] ${content}` }]);
  if(error){ console.error(error); alert("投稿失敗"); return; }
  inputMsg.value = "";
  lastPostTime = now;
  await loadPosts();
});

// 戻る
btnBack.addEventListener("click", ()=>{
  currentThreadId = null;
  viewWrap.style.display="none";
  listView.style.display="block";
  history.replaceState(null,"","./");
});

// リアルタイム
db.channel("rt-posts")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},payload=>{
    if(payload?.new?.thread_id===currentThreadId) loadPosts();
  }).subscribe();

// 初期読み込み
loadThreads();
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("thread");
if(threadId){
  db.from("threads").select("title").eq("id",threadId).maybeSingle()
    .then(res=>{
      if(res.data) openThread(threadId,res.data.title);
    });
}
</script>
</body>
</html>
