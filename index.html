<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おんJ風掲示板</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin:0; padding:20px; }
    #threadList, #threadView { max-width: 600px; margin:auto; }
    .thread, .post { background:#fff; padding:10px; margin:10px 0; border-radius:8px; }
    .thread:hover { background:#f0f0f0; cursor:pointer; }
    form { margin:10px 0; }
    input, textarea, button { width:100%; padding:8px; margin:5px 0; }
    button { background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .time { font-size: 0.8em; color: #555; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>おんJ風掲示板</h1>

  <!-- スレ一覧 -->
  <div id="threadList">
    <h2>スレ一覧</h2>
    <div id="threads"></div>
    <h3>スレ作成</h3>
    <form id="newThreadForm">
      <input type="text" id="newThreadTitle" placeholder="スレタイ" required>
      <button type="submit">作成</button>
    </form>
  </div>

  <!-- スレ詳細 -->
  <div id="threadView" style="display:none;">
    <button id="backBtn">← 戻る</button>
    <h2 id="threadTitle"></h2>
    <div id="posts"></div>
    <h3>レス投稿</h3>
    <form id="newPostForm">
      <textarea id="newPostContent" placeholder="レス内容" required></textarea>
      <button type="submit">書き込む</button>
    </form>
  </div>

  <script>
    const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const threadList = document.getElementById("threadList");
    const threadView = document.getElementById("threadView");
    const threadsDiv = document.getElementById("threads");
    const postsDiv = document.getElementById("posts");
    const threadTitle = document.getElementById("threadTitle");

    let currentThreadId = null;
    let lastPostTime = 0;
    const NG_WORDS = ["死ね","糞","ばか"]; 

    function formatTime(ts) {
      const d = new Date(ts);
      const pad = n => n.toString().padStart(2,'0');
      return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    async function loadThreads() {
      const { data, error } = await supabase.from("threads").select("*").order("created_at", { ascending: false });
      if (error) { console.error(error); return; }
      threadsDiv.innerHTML = "";
      data.forEach(thread => {
        const div = document.createElement("div");
        div.className = "thread";
        div.innerHTML = thread.title + ' <span class="time">(' + formatTime(thread.created_at) + ')</span>';
        div.onclick = () => openThread(thread.id, thread.title);
        threadsDiv.appendChild(div);
      });
    }

    async function openThread(id, title) {
      currentThreadId = id;
      threadTitle.textContent = title;
      threadList.style.display = "none";
      threadView.style.display = "block";
      loadPosts();
    }

    async function loadPosts() {
      const { data, error } = await supabase.from("posts").select("*").eq("thread_id", currentThreadId).order("created_at");
      if (error) { console.error(error); return; }
      postsDiv.innerHTML = "";
      data.forEach(post => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = "名無し : " + post.content + ' <span class="time">(' + formatTime(post.created_at) + ')</span>';
        postsDiv.appendChild(div);
      });
    }

    document.getElementById("newThreadForm").onsubmit = async (e) => {
      e.preventDefault();
      const title = document.getElementById("newThreadTitle").value.trim();
      if(!title) return;
      const { error } = await supabase.from("threads").insert([{ title }]);
      if (error) { alert("スレ作成失敗: " + error.message); return; }
      document.getElementById("newThreadTitle").value = "";
      loadThreads();
    };

    document.getElementById("newPostForm").onsubmit = async (e) => {
      e.preventDefault();
      const content = document.getElementById("newPostContent").value.trim();
      const now = Date.now();

      if (now - lastPostTime < 2000) {
        alert("2秒以内は投稿できません");
        return;
      }

      for (const word of NG_WORDS) {
        if (content.includes(word)) {
          alert("その言葉は書き込みできぬい...");
          return;
        }
      }

      const { error } = await supabase.from("posts").insert([{ content, thread_id: currentThreadId }]);
      if (error) { alert("レス投稿失敗: " + error.message); return; }

      document.getElementById("newPostContent").value = "";
      lastPostTime = now;
      loadPosts();
    };

    document.getElementById("backBtn").onclick = () => {
      threadView.style.display = "none";
      threadList.style.display = "block";
      loadThreads();
    };

    loadThreads();
  </script>
</body>
</html>
