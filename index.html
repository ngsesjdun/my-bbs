<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おんJもどき</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: メイリオ, Meiryo, "ＭＳ ゴシック", "Hiragino Kaku Gothic ProN", "ヒラギノ角ゴ ProN W3", sans-serif; }
    .thread { border: 1px solid #ccc; padding: 8px; margin: 8px; cursor: pointer; }
    .response { margin-left: 20px; }
  </style>
</head>
<body>
  <h1>おんJ風掲示板</h1>

  <!-- スレ作成フォーム -->
  <form id="thread-form">
    <input type="text" id="title" placeholder="スレタイ" required>
    <textarea id="body" placeholder="本文" required></textarea>
    <button type="submit">スレ作成</button>
  </form>

  <div id="threads"></div>

  <!-- レス表示・投稿フォーム -->
  <div id="thread-detail" style="display:none;">
    <h2 id="thread-title"></h2>
    <p id="thread-body"></p>
    <div id="responses"></div>
    <form id="response-form">
      <textarea id="response-text" placeholder="レス内容" required></textarea>
      <button type="submit">レス投稿</button>
    </form>
  </div>

<script>
const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentThreadId = null;

// ランダムID (日付更新 0時ごと)
function generateUserId() {
  const now = new Date();
  const seed = now.toDateString(); // 日付でリセット
  const random = Math.random().toString(36).substring(2, 6);
  return random;
}

// 時刻フォーマット
function formatTime(dateStr) {
  const d = new Date(dateStr);
  return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

// スレ一覧読み込み
async function loadThreads() {
  const { data } = await supabase.from("threads").select("*").order("id", { ascending: false });
  const container = document.getElementById("threads");
  container.innerHTML = "";
  data.forEach(t => {
    const div = document.createElement("div");
    div.className = "thread";
    div.textContent = t.title;
    div.onclick = () => openThread(t);
    container.appendChild(div);
  });
}

// スレ作成
document.getElementById("thread-form").onsubmit = async (e) => {
  e.preventDefault();
  const title = document.getElementById("title").value;
  const body = document.getElementById("body").value;
  await supabase.from("threads").insert([{ title, body }]);
  document.getElementById("title").value = "";
  document.getElementById("body").value = "";
  loadThreads();
};

// スレを開く
async function openThread(thread) {
  currentThreadId = thread.id;
  document.getElementById("thread-title").textContent = thread.title;
  document.getElementById("thread-body").textContent = thread.body;
  document.getElementById("thread-detail").style.display = "block";
  loadResponses();
}

// レス一覧読み込み
async function loadResponses() {
  const { data } = await supabase.from("responses").select("*").eq("thread_id", currentThreadId).order("id", { ascending: true });
  const container = document.getElementById("responses");
  container.innerHTML = "";
  data.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "response";
    const time = formatTime(r.created_at);
    div.textContent = `${i+1}: [${r.user_id}] ${r.content} (${time})`;
    container.appendChild(div);
  });
}

// レス投稿
document.getElementById("response-form").onsubmit = async (e) => {
  e.preventDefault();
  const content = document.getElementById("response-text").value;
  const user_id = generateUserId();
  await supabase.from("responses").insert([{ thread_id: currentThreadId, content, user_id }]);
  document.getElementById("response-text").value = "";
  loadResponses();
};

loadThreads();
</script>
</body>
</html>
