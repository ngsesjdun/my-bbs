<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>おんJ風掲示板</title>
<style>
body { font-family: monospace; background: #1c1c1c; color: #ddd; margin:0; padding:0; }
a { color:#08f; text-decoration:none; }
#header { background:#333; padding:5px; text-align:center; color:white; font-weight:bold; }
#threads, #posts { max-width:600px; margin:auto; padding:5px; }
#threads { background:#2b2b2b; border-radius:5px; margin-top:10px; }
#posts { background:#2b2b2b; border-radius:5px; margin-top:10px; height: 50vh; overflow-y:auto; }
.thread, .post { border-bottom: 1px solid #555; padding:4px; cursor:pointer; }
.thread:last-child, .post:last-child { border-bottom:none; }
.name { color:#08f; font-weight:bold; }
.number { color:red; font-weight:bold; margin-right:5px; }
.time { color:#999; font-size:0.8em; }
#thread-input, #post-input { max-width:600px; margin:auto; margin-top:10px; }
#thread-input input, #post-input input, #thread-input button, #post-input button { padding:5px; font-size:0.9em; }
#thread-input input, #post-input input { margin-right:5px; width:65%; }
#post-input input#name { width:25%; }
#post-input input#message { width:55%; }
button { cursor:pointer; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="header">おんJ風掲示板</div>

<div id="thread-input">
  <input type="text" id="new-thread-title" placeholder="スレッドタイトル">
  <button id="create-thread">スレ作成</button>
</div>

<div id="threads"></div>

<div id="post-input" style="display:none;">
  <input type="text" id="name" placeholder="名前">
  <input type="text" id="message" placeholder="本文">
  <button id="send">書き込む</button>
</div>

<div id="posts"></div>

<script>
const SUPABASE_URL = "https://owopzgeliyhgxpnywscy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93b3B6Z2VsaXloZ3hwbnl3c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjU3MTYsImV4cCI6MjA3MDY0MTcxNn0.0zUkNS8KeXULcl7HxoYQvbD7J0FTf3Z9-4Xq4rpDdX8";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentThreadId = null;

const threadsDiv = document.getElementById("threads");
const postsDiv = document.getElementById("posts");
const newThreadInput = document.getElementById("new-thread-title");
const createThreadBtn = document.getElementById("create-thread");
const nameInput = document.getElementById("name");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("send");

// スレッド一覧
async function loadThreads() {
  const { data, error } = await supabase.from("threads").select("*").order("created_at");
  if (error) { console.error("スレッド読み込み失敗:", error); return; }
  threadsDiv.innerHTML = "";
  data.forEach(thread => {
    const div = document.createElement("div");
    div.className = "thread";
    div.textContent = thread.title;
    div.onclick = () => { currentThreadId = thread.id; loadPosts(); document.getElementById("post-input").style.display="block"; };
    threadsDiv.appendChild(div);
  });
}

// スレ作成
createThreadBtn.onclick = async () => {
  const title = newThreadInput.value.trim();
  if(!title) { alert("タイトルを入力してください"); return; }
  const { data, error } = await supabase.from("threads").insert([{ title }]).select();
  if(error){ console.error("スレ作成失敗:", error); alert("スレ作成失敗"); return; }
  newThreadInput.value="";
  loadThreads();
  if(data && data[0]) { currentThreadId = data[0].id; loadPosts(); document.getElementById("post-input").style.display="block"; }
};

// 投稿読み込み
async function loadPosts() {
  if(!currentThreadId) return;
  const { data, error } = await supabase.from("posts").select("*").eq("thread_id", currentThreadId).order("created_at");
  if(error){ console.error("投稿読み込み失敗:", error); return; }
  postsDiv.innerHTML="";
  data.forEach((post, index)=>{
    const localTime = post.created_at ? new Date(post.created_at+'Z').toLocaleString('ja-JP',{hour12:false}) : "";
    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `<span class="number">${index+1}</span> <span class="name">${post.name||"名無し"}</span>：${post.message||""}<br><span class="time">${localTime}</span>`;
    postsDiv.appendChild(div);
  });
  postsDiv.scrollTop = postsDiv.scrollHeight;
}

// 投稿送信
sendBtn.onclick = async () => {
  if(!currentThreadId) return;
  const name = nameInput.value.trim() || "名無し";
  const message = messageInput.value.trim();
  if(!message) return;
  const { error } = await supabase.from("posts").insert([{ name, message, thread_id: currentThreadId }]);
  if(error){ console.error("投稿失敗:", error); alert("投稿失敗"); return; }
  messageInput.value="";
  loadPosts();
}

// リアルタイム
supabase.channel('realtime-posts')
  .on('postgres_changes', { event:'INSERT', schema:'public', table:'posts' }, payload=>{
    if(payload.new.thread_id===currentThreadId) loadPosts();
  }).subscribe();

loadThreads();
</script>

</body>
</html>
